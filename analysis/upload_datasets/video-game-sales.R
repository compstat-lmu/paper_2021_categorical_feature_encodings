library("OpenML")
library(data.table)

# load OML config file to access server
loadOMLConfig(path = "~/.openml/config", assign = TRUE)

# load dataset
dat = fread(file = "data/videogames_sales/vgsales.csv")

# basic preprocessing

dat[dat == "N/A"] = NA

dat[, Year := as.numeric(Year)]

nominal_vars = c("Platform", "Genre", "Publisher")
dat[, c(nominal_vars) := lapply(.SD, factor), .SDcols = nominal_vars]

# check dataset for inconsistencies
summary(dat)

# OML description
desc = makeOMLDataSetDescription(
  name = "video-game-sales",
  description = "Kaggle dataset containing a list of video games with sales greater than 100,000 copies [https://www.kaggle.com/gregorut/videogamesales#vgsales.csv], which was generated by a scrape of vgchartz.com [https://github.com/GregorUT/vgchartzScrape]. For a description of the dataset, checkout the home of the kaggle dataset repo [https://www.kaggle.com/gregorut/videogamesales/home]. In contrast to the intention of the original author, the categorical variable 'Genre' was selected as the target here. Note that the variable 'Name' (ignored by default) is not unique for each row, as many games are published on more than one 'Platform'. The original dataset was sorted deacreasingly by the variable 'Global_Sales' (which was not changed here), which is why the ID variable 'Rank' directly reflects the rank order of 'Global_Sales'.",
  original.data.url = "https://www.kaggle.com/gregorut/videogamesales#vgsales.csv",
  default.target.attribute = "Genre",
  row.id.attribute = "Rank", 
  ignore.attribute = "Name",
  visibility = "Everyone"
)

# create OML dataset
oml_dat = makeOMLDataSet(
  desc = desc,
  data = dat,
  colnames.old = colnames(dat),
  colnames.new = colnames(dat),
  target.features = "Genre")

# upload dataset to the OML server
# !DO NOT ACCIDENTALLY RUN THIS!

# uploadOMLDataSet(oml_dat)

# Uploading data set to server.
# Uploading to 'http://www.openml.org/api/v1/data'.
# Data set successfully uploaded. Data set ID: 41216
